name: Terraform GCP

on:
  workflow_call:
    inputs:
      gcp_workload_identity_provider:
        description: GCP Workload Identity Provider (e.g., projects/123/locations/global/workloadIdentityPools/pool/providers/provider)
        required: true
        type: string
      gcp_service_account:
        description: GCP Service Account email for Workload Identity
        required: true
        type: string
      working_directory:
        description: Directory containing Terraform configuration
        required: false
        type: string
        default: "."
      terraform_version:
        description: Terraform version to use
        required: false
        type: string
        default: "latest"
      mode:
        description: "Terraform mode: 'plan' or 'apply'"
        required: false
        type: string
        default: "plan"
      plan_args:
        description: Additional arguments for terraform plan
        required: false
        type: string
        default: ""
      apply_args:
        description: Additional arguments for terraform apply
        required: false
        type: string
        default: "-auto-approve"
permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@c200f3691d83b41bf9bbd8638997a462592937ed # v2.1.13
        with:
          workload_identity_provider: ${{ inputs.gcp_workload_identity_provider }}
          service_account: ${{ inputs.gcp_service_account }}

      - name: Setup aqua cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.local/share/aquaproj-aqua
            ~/.cache/aquaproj-aqua
          key: ${{ runner.os }}-aqua-${{ hashFiles('aqua.yaml') }}
          restore-keys: |
            ${{ runner.os }}-aqua-

      - name: Install aqua
        uses: aquaproj/aqua-installer@11dd79b4e498d471a9385aa9fb7f62bb5f52a73c # v4.0.4
        with:
          aqua_version: v2.56.2

      - name: Install tfcmt
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if [ ! -f aqua.yaml ]; then
            aqua init
            aqua g -i suzuki-shunsuke/tfcmt
          fi
          aqua i
          export PATH="$(aqua root-dir)/bin:$PATH"
          echo "$(aqua root-dir)/bin" >> $GITHUB_PATH
          tfcmt --version

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Terraform Init
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        run: terraform init

      - name: Terraform Plan
        if: inputs.mode == 'plan'
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        env:
          TFCMT_GITHUB_TOKEN: ${{ github.token }}
        run: tfcmt plan -patch -- terraform plan ${{ inputs.plan_args }}

      - name: Terraform Apply
        if: inputs.mode == 'apply'
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        env:
          TFCMT_GITHUB_TOKEN: ${{ github.token }}
        run: tfcmt apply -- terraform apply ${{ inputs.apply_args }}
