name: Terraform GitHub

on:
  workflow_call:
    inputs:
      gcp_workload_identity_provider:
        description: GCP Workload Identity Provider (e.g., projects/123/locations/global/workloadIdentityPools/pool/providers/provider)
        required: true
        type: string
      gcp_service_account:
        description: GCP Service Account email for Workload Identity
        required: true
        type: string
      working_directory:
        description: Directory containing Terraform configuration
        required: false
        type: string
        default: "."
      terraform_version:
        description: Terraform version to use
        required: false
        type: string
        default: "latest"
      mode:
        description: "Terraform mode: 'plan' or 'apply'"
        required: false
        type: string
        default: "plan"
      plan_args:
        description: Additional arguments for terraform plan
        required: false
        type: string
        default: ""
      apply_args:
        description: Additional arguments for terraform apply
        required: false
        type: string
        default: "-auto-approve"
    secrets:
      gh_app_id:
        description: GitHub App ID for Terraform GitHub provider authentication (use with gh_app_private_key)
        required: false
      gh_app_private_key:
        description: GitHub App Private Key (PEM format) for Terraform GitHub provider (use with gh_app_id)
        required: false
      gh_token:
        description: Personal Access Token for Terraform GitHub provider (alternative to GitHub App, required for personal accounts)
        required: false

permissions:
  contents: read
  id-token: write
  pull-requests: write

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - name: Validate authentication
        shell: bash
        env:
          GH_APP_ID: ${{ secrets.gh_app_id }}
          GH_TOKEN: ${{ secrets.gh_token }}
        run: |
          if [ -z "$GH_APP_ID" ] && [ -z "$GH_TOKEN" ]; then
            echo "::error::Either gh_app_id/gh_app_private_key or gh_token must be provided"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ inputs.gcp_workload_identity_provider }}
          service_account: ${{ inputs.gcp_service_account }}

      - name: Setup aqua cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/aquaproj-aqua
            ~/.cache/aquaproj-aqua
          key: ${{ runner.os }}-aqua-${{ hashFiles('aqua.yaml') }}
          restore-keys: |
            ${{ runner.os }}-aqua-

      - name: Install aqua
        uses: aquaproj/aqua-installer@v4.0.4
        with:
          aqua_version: v2.56.2

      - name: Install tfcmt
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          AQUA_GHATTESTATION_DISABLED: "true"
        run: |
          if [ ! -f aqua.yaml ]; then
            aqua init
            aqua g -i suzuki-shunsuke/tfcmt
          fi
          aqua i
          export PATH="$(aqua root-dir)/bin:$PATH"
          echo "$(aqua root-dir)/bin" >> $GITHUB_PATH
          tfcmt --version

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Generate GitHub App Token
        if: ${{ secrets.gh_app_id != '' }}
        id: github-app-token
        uses: actions/create-github-app-token@v2.1.4
        with:
          app-id: ${{ secrets.gh_app_id }}
          private-key: ${{ secrets.gh_app_private_key }}
          owner: ${{ github.repository_owner }}

      - name: Terraform Init
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        env:
          GITHUB_TOKEN: ${{ secrets.gh_app_id != '' && steps.github-app-token.outputs.token || secrets.gh_token }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: terraform init

      - name: Terraform Plan
        if: inputs.mode == 'plan'
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        env:
          TFCMT_GITHUB_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ secrets.gh_app_id != '' && steps.github-app-token.outputs.token || secrets.gh_token }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: tfcmt plan -patch -- terraform plan ${{ inputs.plan_args }}

      - name: Terraform Apply
        if: inputs.mode == 'apply'
        shell: bash
        working-directory: ${{ inputs.working_directory }}
        env:
          TFCMT_GITHUB_TOKEN: ${{ github.token }}
          GITHUB_TOKEN: ${{ secrets.gh_app_id != '' && steps.github-app-token.outputs.token || secrets.gh_token }}
          GITHUB_OWNER: ${{ github.repository_owner }}
        run: tfcmt apply -- terraform apply ${{ inputs.apply_args }}
